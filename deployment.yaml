apiVersion: apps/v1
kind: Deployment
metadata:
  name: board-app
  namespace: board
spec:
  replicas: 2
  selector:
    matchLabels:
      app: board-app
  template:
    metadata:
      labels:
        app: board-app
    spec:
      containers:
        - name: jboss
          image: default-route-openshift-image-registry.apps.ext2.mtp.local/board/eap74-openjdk17-openshift-rhel8:2025-03-13-14-54-33
          ports:
            - containerPort: 8080
          env:
            - name: WILDFLY_BIND
              value: "0.0.0.0"
            - name: WILDFLY_PORT
              value: "8080"
            - name: WILDFLY_ENABLE_HTTPS
              value: "false"
            - name: WILDFLY_ENABLE_HTTP
              value: "true"
          command: ["/bin/sh", "-c"]
          args:
            - |
              LOGGING_CONFIG="/opt/eap/standalone/configuration/logging.properties"
              XML_CONFIG="/opt/eap/standalone/configuration/standalone-openshift.xml"

              echo "Removing activemq-rar.rar to prevent deployment failure..."
              rm -f /opt/eap/standalone/deployments/activemq-rar.rar

              echo "Ensuring activemq-rar.rar is undeployed in JBoss CLI..."
              /opt/eap/bin/jboss-cli.sh --connect --commands="undeploy activemq-rar.rar --keep-content, quit"

              echo "Verifying activemq-rar.rar is removed..."
              if [ -f "/opt/eap/standalone/deployments/activemq-rar.rar" ]; then
                echo "ERROR: activemq-rar.rar still exists!"
                exit 1
              fi

              echo "Setting up JBoss logging configuration..."
              cat << EOF > $XML_CONFIG
              <formatter name="CONSOLE-FORMATTER">
                <pattern-formatter pattern="%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n"/>
              </formatter>
              EOF

              cat << EOF > $LOGGING_CONFIG
              formatter.CONSOLE-FORMATTER=org.jboss.logmanager.formatters.PatternFormatter
              formatter.CONSOLE-FORMATTER.pattern=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c] (%t) %s%E%n
              EOF

              echo "Starting JBoss..."
              exec /opt/eap/bin/standalone.sh -b 0.0.0.0 --server-config=standalone-openshift.xml
